<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Consulta de Moedas - Avaliação A1.2</title>
    <link rel="shortcut icon" type="image/x-icon" href="imagens/dinheiro.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 1.5rem;
            padding-bottom: 4rem;
        }

        footer {
            background: #f8f9fa;
            padding: 1rem 0;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        .mono {
            font-family: monospace;
        }

        .card-moeda {
            min-width: 220px;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="mb-4">
            <h1 class="h3">Consulta de Moedas</h1>
        </header>
        <main>
            <section class="card mb-4">
                <div class="card-body">
                    <h5>Consulta de moeda específica</h5>
                    <form id="formMoedas" class="row g-3 align-items-end">
                        <div class="col-12 col-md-4">
                            <label for="moeda1" class="form-label">Moeda principal</label>
                            <select id="moeda1" class="form-select" required>
                                <option value="">Selecione</option>
                                <option value="USD">USD - Dólar americano</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - Libra esterlina</option>
                                <option value="JPY">JPY - Iene</option>
                                <option value="AUD">AUD - Dólar australiano</option>
                                <option value="CAD">CAD - Dólar canadense</option>
                                <option value="CHF">CHF - Franco suíço</option>
                                <option value="CNY">CNY - Yuan chinês</option>
                                <option value="BTC">BTC - Bitcoin</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="moeda2" class="form-label">Segunda moeda (opcional)</label>
                            <select id="moeda2" class="form-select">
                                <option value="">Nenhuma</option>
                                <option value="USD">USD - Dólar americano</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - Libra esterlina</option>
                                <option value="JPY">JPY - Iene</option>
                                <option value="AUD">AUD - Dólar australiano</option>
                                <option value="CAD">CAD - Dólar canadense</option>
                                <option value="CHF">CHF - Franco suíço</option>
                                <option value="CNY">CNY - Yuan chinês</option>
                                <option value="BTC">BTC - Bitcoin</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2 d-grid">
                            <button type="button" class="btn btn-primary" onclick="consultarMoedas()">Consultar</button>
                        </div>
                    </form>
                </div>
            </section>
            <section class="card mb-4">
                <div class="card-body">
                    <h5>Filtrar moedas por variação (%)</h5>
                    <form id="formFiltro" class="row g-3 align-items-end">
                        <div class="col-12 col-md-4">
                            <label for="valorFiltro" class="form-label">Variação mínima (%)</label>
                            <input type="number" step="0.01" id="valorFiltro" class="form-control" placeholder="Ex: 1.5"
                                required>
                        </div>
                        <div class="col-12 col-md-2 d-grid">
                            <button type="button" class="btn btn-success" onclick="filtrarMoedas()">Filtrar por
                                variação</button>
                        </div>
                        <div class="col-12 col-md-2 d-grid">
                            <button type="button" class="btn btn-danger" onclick="limparCards()">Limpar Cards</button>
                        </div>
                    </form>
                </div>
            </section>
            <section class="mb-4">
                <h2 class="h5">Resumo atual</h2>
                <div id="cardsMoedas" class="d-flex flex-wrap gap-3"></div>
            </section>
            <section class="mb-5">
                <h2 class="h5">Histórico de consultas</h2>
                <div class="table-responsive">
                    <table id="tabelaHistorico" class="table table-striped table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Moeda</th>
                                <th>Nome</th>
                                <th>Compra</th>
                                <th>Venda</th>
                                <th>Variação (%)</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>


        <section class="card mb-4">
            <div class="card-body">
                <h5>Consulta e exclusão de log</h5>
                <form id="formMoedas" class="row g-3 align-items-end">
                    <div class="col-12 col-md-4">
                        <label for="moedaex" class="form-label">Moeda a excluir</label>
                        <select id="moedaex" class="form-select" required>
                            <option value="">Selecione</option>
                            <option value="USD">USD - Dólar americano</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - Libra esterlina</option>
                            <option value="JPY">JPY - Iene</option>
                            <option value="AUD">AUD - Dólar australiano</option>
                            <option value="CAD">CAD - Dólar canadense</option>
                            <option value="CHF">CHF - Franco suíço</option>
                            <option value="CNY">CNY - Yuan chinês</option>
                            <option value="BTC">BTC - Bitcoin</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2 d-grid">
                        <button type="button" class="btn btn-danger" onclick="limparlog()">Excluir seleção</button>
                    </div>

                    <div class="col-12 col-md-2 d-grid">
                        <button type="button" class="btn btn-primary" onclick="consultarlog()">Consultar</button>
                    </div>

                </form>
            </div>
        </section>

        <h2 class="h5">Histórico de log</h2>

        <ul id="resultados">
            <li>Resultados</li>
        </ul </div>

        <footer class="text-center" style="display: flex; justify-content: center; align-items: center; gap: 0.4%;">
            <div>MICHAEL ZAT — FUNDAMENTOS AO DESENVOLVIMENTO WEB - 2025/2
                <img src="imagens/trabalhar.gif" alt="Seu GIF" class="footer-gif" style="width: 2%;">
            </div>

        </footer>


        <script>
            const apiKey = "d65102712161ea9dc6760d46b6049aac715080358ae9880e5a5d45cd6fbcc83d";
            const tabelaBody = document.querySelector('#tabelaHistorico tbody');;
            const cardsMoedas = document.getElementById('cardsMoedas');
            const moedasUnicas = new Map();
            async function consultarMoeda(sigla) {
                const url = `https://economia.awesomeapi.com.br/json/last/${sigla}-BRL?token=${apiKey}`;
                const resp = await fetch(url);
                const data = await resp.json();
                const chave = Object.keys(data)[0];
                return data[chave];
            }
            function adicionarLinhaHistorico(d) {
                const tr = document.createElement('tr');
                const urllog = `https://www.piway.com.br/unoesc/api/inserir/log/406860/awesomeapi/post/${d.code}`;
                const resp = fetch(urllog);
                console.log(urllog);
                tr.innerHTML = `
                <td>${d.code}</td>
                <td>${d.name}</td>
                <td class="mono">${d.bid}</td>
                <td class="mono">${d.ask}</td>
                <td>${d.pctChange}</td>
                <td>${new Date(d.timestamp * 1000).toLocaleString()}</td>`;
                tabelaBody.prepend(tr);
            }


            async function consultarlog() {
                let urllog = `https://www.piway.com.br/unoesc/api/logs/406860`;
                let resposta = await fetch(urllog);
                let dados = await resposta.json();
                console.log(dados);
            
                
                console.log(dados);

                let nomes = document.getElementById('resultados');
                nomes.innerHTML = '';
                for (let item of dados) {
                    nomes.innerHTML += `<li>${item.resultado}</li>`;
                }
            }

            function atualizarCards() {
                cardsMoedas.innerHTML = '';
                for (const [sigla, d] of moedasUnicas.entries()) {
                    const card = document.createElement('div');
                    card.className = 'card card-moeda shadow-sm';
                    card.innerHTML = `
                    <div class="card-body p-3">
                        <h6 class="card-title">${d.code}</h6>
                        <p class="mb-1"><strong>Compra:</strong> ${d.bid}</p>
                        <p class="mb-1"><strong>Venda:</strong> ${d.ask}</p>
                        <p class="mb-1"><strong>Variação:</strong> ${d.pctChange}%</p>
                        <small class="text-muted">${d.name}</small>
                    </div>`;
                    cardsMoedas.appendChild(card);
                }
            }
            async function consultarMoedas() {
                const m1 = document.getElementById('moeda1').value;
                const m2 = document.getElementById('moeda2').value;
                if (!m1) {
                    alert("Selecione a moeda principal.");
                    return;
                }
                moedasUnicas.clear();
                cardsMoedas.innerHTML = '';
                const moedasParaBuscar = [m1];
                if (m2 && m2 !== m1) moedasParaBuscar.push(m2);
                for (const sigla of moedasParaBuscar) {
                    const dados = await consultarMoeda(sigla);
                    adicionarLinhaHistorico(dados);
                    moedasUnicas.set(sigla, dados);
                }
                atualizarCards();
            }
            async function filtrarMoedas() {
                const valor = parseFloat(document.getElementById('valorFiltro').value);
                if (isNaN(valor)) {
                    alert('Digite um valor válido de variação.');
                    return;
                }
                moedasUnicas.clear();
                cardsMoedas.innerHTML = '';
                const todasMoedas = ["USD", "EUR", "GBP", "JPY", "AUD", "CAD", "CHF", "CNY", "BTC"];
                for (const sigla of todasMoedas) {
                    const d = await consultarMoeda(sigla);
                    const varNum = Math.abs(parseFloat(d.pctChange));
                    if (varNum >= valor) {
                        adicionarLinhaHistorico(d);
                        moedasUnicas.set(sigla, d);
                    }
                }
                atualizarCards();
            }
            function limparCards() {
                cardsMoedas.innerHTML = '';
                moedasUnicas.clear();
            }

           async function limparlog() {
            const moex = document.getElementById('moedaex').value;
                let urllog = `https://www.piway.com.br/unoesc/api/excluir/log/${moex}/aluno/406860`;
                let resposta = await fetch(urllog);
                let dados = await resposta.json();
                console.log(dados);
            
            }
        </script>
</body>

</html>